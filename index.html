<!DOCTYPE html>
<html>
<head>
  <title>TM + MQTT</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image"></script>
  <script src="https://unpkg.com/paho-mqtt/mqttws31.min.js"></script>
</head>
<body>
  <button onclick="init()">Start</button>
  <div id="label-container"></div>

<script>
  // URL โมเดล Teachable Machine
  const URL = "https://teachablemachine.withgoogle.com/models/klxDOYTDp/";

  let model, webcam, labelContainer, maxPredictions;

  // สร้าง MQTT client
  const client = new Paho.MQTT.Client("broker.hivemq.com", 8884, "client_" + Math.random());

  client.connect({
    onSuccess: () => {
      console.log("MQTT connected");
    },
    onFailure: (e) => {
      console.error("MQTT connect error:", e.errorMessage);
    }
  });

  async function init() {
    const modelURL = URL + "model.json";
    const metadataURL = URL + "metadata.json";

    model = await tmImage.load(modelURL, metadataURL);
    maxPredictions = model.getTotalClasses();

    webcam = new tmImage.Webcam(200, 200, true);
    await webcam.setup();
    await webcam.play();
    window.requestAnimationFrame(loop);

    document.body.appendChild(webcam.canvas);
    labelContainer = document.getElementById("label-container");
    for (let i = 0; i < maxPredictions; i++) {
      labelContainer.appendChild(document.createElement("div"));
    }
  }

  async function loop() {
    webcam.update();
    await predict();
    window.requestAnimationFrame(loop);
  }

  async function predict() {
    const prediction = await model.predict(webcam.canvas);
    let topClass = "", topProb = 0;

    for (let i = 0; i < prediction.length; i++) {
      labelContainer.childNodes[i].innerHTML = prediction[i].className + ": " + prediction[i].probability.toFixed(2);
      if (prediction[i].probability > topProb) {
        topProb = prediction[i].probability;
        topClass = prediction[i].className;
      }
    }

    // ส่งข้อความไปยัง MQTT topic "ktmn" เมื่อมั่นใจมากกว่า 0.7
    if (topProb > 0.7 && client.isConnected()) {
      let message = new Paho.MQTT.Message(topClass);
      message.destinationName = "ktmn";
      client.send(message);
      console.log("ส่งไปยัง MQTT:", topClass);
    }
  }
</script>
</body>
</html>

